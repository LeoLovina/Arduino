<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
    crossorigin="anonymous">

  <title>IoT Arduino Control</title>
</head>

<body>
  <div class="container">
    <div class="jumbotron jumbotron-fluid">
      <div class="container">
        <h1 class="display-2">物聯網實作</h1>
        <p class="lead text-info">收集資料和傳送資料到雲端、輕鬆載入和分析該資訊，且提供管理裝置的能力！ 隨時可溝通。可靠地擴展。數兆則訊息。數十億個裝置。</p>
      </div>
    </div>
  </div>
  <div class="container">
    <!-- Relay 控制-->
    <div class="jumbotron">
      <h1>LED 燈控制</h1>
      <div class="btn-group btn-group-large" role="group" aria-label="Basic example">
        <button type="button" class="btn btn-success" id="openBtn">ON</button>
        <button type="button" class="btn btn-danger" id="closeBtn">OFF</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="row">
      <div class="col-lg-3 col-md-12">
        <div class="card">
          <img class="card-img-top" src="images/htu21D.png" alt="Card image cap">
          <div class="card-body">
            <h5 class="card-title">數位相對濕度感測器</h5>
            <p class="card-text">Measurement Specialties HTU21D數位相對濕度感測器嵌入於回流焊接雙列平面無導線(DFN)封裝，面積3 x
              3mm、高度1mm，可提供數位、I²C格式的已校準線性化訊號。HTU21D感測器是專用的濕度與溫度隨插即用傳感器，適用於需要可靠性與準確測量的OEM應用。透過模組化濕度與溫度數位輸出，可提供與微控制器直接連接的介面。</p>
            <button type="button" class="btn btn-primary">
              溫度 <span class="badge badge-light" id="Temperature">4</span>
            </button>
            <button type="button" class="btn btn-primary">
              濕度 <span class="badge badge-light" id="Humidity">4</span>
            </button>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-md-4">
        <div class="card">
          <img class="card-img-top" src="images/soundSensor.png" alt="Card image cap">
          <div class="card-body">
            <h5 class="card-title">聲音感應模組</h5>
            <p class="card-text">聲音感測模組是一個麥克風元件。基於功率放大器LM386 電容式麥克風，它可以用於檢測偵測環境中的聲音強度。而偵測到的資料輸出的值可以由電位進行調整。</p>
            <button type="button" class="btn btn-primary">
              聲音感應模組 <span class="badge badge-light" id="Sound_LED">4</span>
            </button>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-md-4">
        <div class="card">
          <img class="card-img-top" src="images/reedSensor.png" alt="Card image cap">
          <div class="card-body">
            <h5 class="card-title">磁簧開關</h5>
            <p class="card-text">磁簧开关是由两片磁簧片(通常由铁和镍这两种金属所组成的) 密封在玻璃管内。 两片磁簧片呈重迭状况但中间间隔有一小空隙，外来适当的磁场将会使两片磁簧片接触。</p>
            <button type="button" class="btn btn-primary">
              目前窗戶關關狀態 <span class="badge badge-light" id="Window">4</span>
            </button>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-md-4">
        <div class="card">
          <img class="card-img-top" src="images/31gegBx9pVL._SY355_.jpg" alt="Dust image">
          <div class="card-body">
            <h5 class="card-title">Sharp 空污傳感器</h5>
            <p class="card-text">harp 空污傳感器 GP2Y1010AU0F偵測空氣懸浮微粒汙染PM2.5
              資料線(黃)接 ESP8266 A0接腳，5v(紅線)和接地(黑線)直接接到麵包板上，這樣就可以了。</p>
            <button type="button" class="btn btn-primary">
              懸浮微粒 <span class="badge badge-light" id="DustPM25">4</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- RFID -->
  <div class="container">
    <div class="jumbotron">
      <h1 class="display-4">RFID門禁控制</h1>
      <table class="table" id="tableRFIDCard">
        <thead>
          <tr>
            <th scope="col">Card ID</th>
            <th scope="col">姓名</th>
            <th scope="col">時間</th>

          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">1</th>
            <td>Mark</td>
            <td>1970-1-1</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <div id='hiddenDiv'>
  </div>

  <!-- RFID List-->
  <div class="container">
    <div class="jumbotron">
      <h1 class="display-4">RFID查詢</h1>
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown"
          aria-haspopup="true" aria-expanded="false">
          門禁人員出入查詢
        </button>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton" id="namelist">
          <a class="dropdown-item" href="#">Action</a>
          <a class="dropdown-item" href="#">Another action</a>
          <a class="dropdown-item" href="#">Something else here</a>
        </div>
      </div>
      <table class="table" id="tableRFIDCardSearch">
        <thead>
          <tr>
            <th scope="col">Card ID</th>
            <th scope="col">姓名</th>
            <th scope="col">時間</th>

          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">1</th>
            <td>Mark</td>
            <td>1970-1-1</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- RFID -->
  <div class="container">
    <div class="jumbotron">
      <h1 class="display-4">PM 2.5</h1>
      <table class="table" id="tablePM25">
        <thead>
          <tr>
            <th scope="col">時間</th>
            <th scope="col">ug/m3</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">1</th>
            <td>1970-1-1</td>
            <td>0</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>


  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
    crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/5.5.4/firebase.js"></script>
  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyDcMu--bU5K9JVa7AMM_C910pCSDJgC0ys",
      authDomain: "arduino-ff0bc.firebaseapp.com",
      databaseURL: "https://arduino-ff0bc.firebaseio.com",
      projectId: "arduino-ff0bc",
      storageBucket: "arduino-ff0bc.appspot.com",
      messagingSenderId: "687040984573"
    };
    firebase.initializeApp(config);

    // Get a reference to the database service
    var database = firebase.database();

    $(document).ready(function () {
      var relayRef = database.ref('iot0901/relay');
      relayRef.on('value', function (snapshot) {
        var relayVal = snapshot.val();
        if (relayVal) {
          $('#openBtn').removeClass('btn-success').addClass('btn-secondary');
          $('#closeBtn').removeClass('btn-secondary').addClass('btn-danger');
        } else {
          $('#openBtn').removeClass('btn-secondary').addClass('btn-success');
          $('#closeBtn').removeClass('btn-danger').addClass('btn-secondary');
        }
        //        console.log('relayVal : ' + relayVal);
      });

      $('#openBtn').click(function () {
        relayRef.set(true);
      });

      $('#closeBtn').click(function () {
        relayRef.set(false);
      });
    });

    $(document).ready(function () {
      setupFirebaseSensor('iot0901/Temperature');
      setupFirebaseSensor('iot0901/Humidity');
      setupFirebaseSensor('iot0901/Sound_LED');
      setupFirebaseSensor('iot0901/Window');
      setupFirebaseSensor('iot0901/DustPM25');

      function setupFirebaseSensor(realtimePath) {
        var relayRef = database.ref(realtimePath);
        relayRef.on('value', function (snapshot) {
          var relayVal = snapshot.val();
          $('#' + snapshot.key).html('' + relayVal);
        });
      }
    });

    $(document).ready(function () {
      // remove all rows from tableRFIDCard
      $('#tableRFIDCard tbody').empty();

      // order by value
      //      var recordsRef = database.ref('iot0901/InRecords/1d_9_5d_f4_');
      // var recordsRef = database.ref('iot0901/InRecords');
      // var sortedRecords = recordsRef.orderByValue().limitToLast(2);
      // sortedRecords.on('value', function (childSnapshot, prevChildKey) {
      //   var addedData = childSnapshot.val();
      //   console.log(addedData);
      // });

      // order by key
      // var recordsRef = database.ref('iot0901/InRecords');
      // var sortedRecords = recordsRef.orderByKey().limitToLast(10);
      // sortedRecords.on('child_added', function (childSnapshot) {
      //   var addedData = childSnapshot.val();
      //   console.log(addedData);
      // });


      var realtimePath = 'iot0901/InRecords'
      var relayRef = database.ref(realtimePath + "/name");
      relayRef.on('child_added', function (snapshot) {
        var val = snapshot.val();
        var key = snapshot.key;
        // put data in hidden field
        $("#hiddenDiv").append('<input type="hidden" id="' + key + '"  value="' + val + '">');
        // setup listen event
        setupFirebaseRFID(realtimePath + "/" + key);
      });

      function setupFirebaseRFID(realtimePath) {
        //        console.log('setup realtimePath=' + realtimePath);
        var recordsRef = database.ref(realtimePath);
        //var sortedRecords = recordsRef.orderByKey().limitToLast(20);
        var sortedRecords = recordsRef.orderByValue().limitToLast(3);
        sortedRecords.on('child_added', function (snapshot) {
          var addedData = snapshot.val();
          //          console.log(addedData);
          var timestamp = snapshot.val() || 0;
          var val = new Date(timestamp);
          var key = snapshot.ref.parent.getKey();
          var carId = key.split('_').join(' ').toUpperCase();
          // read card's owner (name) from hidden field
          var name = $('#' + key).val();

          var newRowContent = "<tr><td>" + carId + "</td><td>" + name + "</td><td>" + getYYYYMMDD(val) +
            "</td></tr>";
          $('#tableRFIDCard tbody').append(newRowContent);
        });
      }

      // function getYYYYMMDD(d) {
      //   return d.getFullYear() + " " +
      //     ("00" + (d.getMonth() + 1)).slice(-2) + "/" +
      //     ("00" + d.getDate()).slice(-2) + "/" +
      //     ("00" + d.getHours()).slice(-2) + ":" +
      //     ("00" + d.getMinutes()).slice(-2) + ":" +
      //     ("00" + d.getSeconds()).slice(-2);
      // }
    });

    function getYYYYMMDD(d) {
      return d.getFullYear() + " " +
        ("00" + (d.getMonth() + 1)).slice(-2) + "/" +
        ("00" + d.getDate()).slice(-2) + "/" +
        ("00" + d.getHours()).slice(-2) + ":" +
        ("00" + d.getMinutes()).slice(-2) + ":" +
        ("00" + d.getSeconds()).slice(-2);
    }

    $(document).ready(function () {
      var realtimePath = 'iot0901/InRecords'
      var nameRef = database.ref(realtimePath + "/name");
      nameRef.on('value', function (snapshot) {
        $('#namelist').empty();
        $('#tableRFIDCardSearch tbody').empty();
        var names = snapshot.val();
        console.log(names);
        for (Cid in names) {
          $('<a class="dropdown-item" href="#' + Cid + '">' + names[Cid] + '</a>').prependTo('#namelist');
        }
        // setup event for dropdown item
        $('.dropdown-menu a').click(function () {
          var dropitemHref = $(this).attr('href');
          var cardId = dropitemHref.substring(1);
          console.log('cardId=' + cardId);
          showCardInOut(cardId);
        });
      });

      function showCardInOut(cardId) {
        var recordRef = database.ref(realtimePath + "/" + cardId);
        var sortedRecords = recordRef.orderByValue(); //.limitToLast(3);
        sortedRecords.once('value', function (snapshot) {
          $('#tableRFIDCardSearch tbody').empty();
          var timeStamps = snapshot.val();
          var cardId = snapshot.key;
          for (key in timeStamps) {
            var name = $('#' + cardId).val();
            var val = new Date(timeStamps[key]);
            var newRowContent = "<tr><td>" + cardId + "</td><td>" + name + "</td><td>" + getYYYYMMDD(val) +
              "</td></tr>";
            $('#tableRFIDCardSearch tbody').append(newRowContent);
          }
        });
      }

    })

    $(document).ready(function () {
      var realtimePath = 'iot0901/DustPM25S'
      var nameRef = database.ref(realtimePath);
      nameRef.on('value', function (snapshot) {
        $('#tablePM25 tbody').empty();
        var values = snapshot.val();
        console.log(values)
        for (key in values) {
          var pmDate = new Date(values[key].timeStamp);
          var pmValue = values[key].value;
          var newRowContent = "<tr><td>" +  getYYYYMMDD(pmDate) + "</td><td>" + pmValue + "</td></tr>";
          $('#tablePM25 tbody').append(newRowContent);
        }
        
      });
    })    
  </script>
</body>

</html>